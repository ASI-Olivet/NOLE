<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Load Leaflet CSS -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>NOLE — Tampa Bay Map</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html,
    body,
    #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    /* Kid-friendly popup text */
    .nole-popup-label {
      font-size: 14px;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div id="map" aria-label="Tampa Bay Map"></div>

  <!-- Load Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>

    // 1. Base map setup

    var centerStPete = [27.77, -82.64];

    var tampaBounds = L.latLngBounds(
      [26.9, -83.2],   // SW
      [28.6, -81.9]    // NE
    );

    var map = L.map("map", {
      minZoom: 9,
      maxZoom: 18,
      maxBounds: tampaBounds,
      maxBoundsViscosity: 0.9
    }).setView(centerStPete, 11);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    L.control.scale({ metric: true, imperial: true }).addTo(map);

    console.log("Leaflet version:", L.version);

    // --------------------------------------------------------------------
    //    Point symbology helper for ENC features
    //    beacon       -> #00FA00 small circle
    //    buoy         -> #0432FF small circle
    //    coastguard   -> #FF9300 large square
    //    fog signal   -> #FFFC00 medium circle
    //    offshore     -> #008F00 medium square
    //    wreck        -> #FF0000 medium X
    // --------------------------------------------------------------------
    function makePointMarker(pointClass, latlng) {
      if (pointClass === "beacon") {
        return L.circleMarker(latlng, {
          radius: 4,
          color: "#00FA00",
          weight: 1,
          fillColor: "#00FA00",
          fillOpacity: 0.9
        });
      } else if (pointClass === "buoy") {
        return L.circleMarker(latlng, {
          radius: 4,
          color: "#0432FF",
          weight: 1,
          fillColor: "#0432FF",
          fillOpacity: 0.9
        });
      } else if (pointClass === "coastguard") {
        return L.marker(latlng, {
          icon: L.divIcon({
            className: "",
            html: '<div style="width:16px;height:16px;background:#FF9300;"></div>',
            iconSize: [16, 16],
            iconAnchor: [8, 8]
          })
        });
      } else if (pointClass === "fog-signal") {
        return L.circleMarker(latlng, {
          radius: 6,
          color: "#FFFC00",
          weight: 1,
          fillColor: "#FFFC00",
          fillOpacity: 0.9
        });
      } else if (pointClass === "offshore-platform") {
        return L.marker(latlng, {
          icon: L.divIcon({
            className: "",
            html: '<div style="width:12px;height:12px;background:#008F00;"></div>',
            iconSize: [12, 12],
            iconAnchor: [6, 6]
          })
        });
      } else if (pointClass === "wreck") {
        return L.marker(latlng, {
          icon: L.divIcon({
            className: "",
            html: '<div style="color:#FF0000;font-size:16px;font-weight:bold;line-height:14px;">x</div>',
            iconSize: [16, 16],
            iconAnchor: [8, 7]
          })
        });
      } else {
        // default small white circle
        return L.circleMarker(latlng, {
          radius: 4,
          color: "#ffffff",
          weight: 1,
          fillColor: "#ffffff",
          fillOpacity: 0.7
        });
      }
    }

    // ENC layer configuration (labels for kid-friendly popups)

    var encLayers = [
      // ---- Coastal ----
      {
        name: "Coastal Bridges",
        file: "Coastal_Bridge_area_4326_clipTB.geojson",
        label: "Bridge",
        style: {
          color: "#ff00ff",
          weight: 2,
          fillColor: "#ff00ff",
          fillOpacity: 0.3
        }
      },
      {
        name: "Coastal Buoy Lateral",
        file: "Coastal_Buoy_Lateral_point_4326_clipTB.geojson",
        label: "Buoy",
        pointClass: "buoy"
      },
      {
        name: "Coastal Buoy Safe Water",
        file: "Coastal_Buoy_Safe_Water_point_4326_clipTB.geojson",
        label: "Buoy",
        pointClass: "buoy"
      },
      {
        name: "Coastal Fairway (clipped)",
        file: "Coastal_Fairway_area_4326_clipTB.geojson",
        label: "Ship Fairway",
        style: {
          color: "#00ff00",
          weight: 2,
          fillColor: "#00ff00",
          fillOpacity: 0.2
        }
      },
      {
        name: "Coastal Radar Transponder Beacons",
        file: "Coastal_Radar_Transponder_Beacon_point_4326_clipTB.geojson",
        label: "Beacon",
        pointClass: "beacon"
      },
      {
        name: "Coastal Wrecks",
        file: "Coastal_Wreck_point_4326_clipTB.geojson",
        label: "Wreck",
        pointClass: "wreck"
      },

      // ---- General ----
      {
        name: "General Buoy Special Purpose",
        file: "General_Buoy_Special_Purpose_General_point_4326_clipTB.geojson",
        label: "Buoy",
        pointClass: "buoy"
      },
      {
        name: "General Obstructions",
        file: "General_Obstruction_area_4326_clipTB.geojson",
        label: "Obstruction",
        style: {
          color: "#ff6600",
          weight: 2,
          fillColor: "#ff6600",
          fillOpacity: 0.25
        }
      },

      // ---- Harbour (first batch) ----
      {
        name: "Harbour Buoy Special Purpose",
        file: "Harbour_Buoy_Special_Purpose_General_point_4326_clipTB.geojson",
        label: "Buoy",
        pointClass: "buoy"
      },
      {
        name: "Harbour Submarine Cables",
        file: "Harbour_Cable_Submarine_line_4326_clipTB.geojson",
        label: "Subsea Cable",
        style: {
          color: "#00ffff",
          weight: 2
        }
      },
      {
        name: "Harbour Coastguard Stations",
        file: "Harbour_Coastguard_Station_point_4326_clipTB.geojson",
        label: "Military",
        pointClass: "coastguard"
      },
      {
        name: "Harbour Coastline",
        file: "Harbour_Coastline_line_4326_clipTB.geojson",
        label: "coastline",
        style: {
          color: "#ffffff",
          weight: 1
        }
      },
      {
        name: "Harbour Fairways",
        file: "Harbour_Fairway_area_4326_clipTB.geojson",
        label: "Ship Fairway",
        style: {
          color: "#0000ff",
          weight: 2,
          fillColor: "#0000ff",
          fillOpacity: 0.25
        }
      },
      {
        name: "Harbour Fog Signals",
        file: "Harbour_Fog_Signal_point_4326_clipTB.geojson",
        label: "Fog Signal",
        pointClass: "fog-signal"
      },
      {
        name: "Harbour Marine Farms",
        file: "Harbour_Marine_Farm_Culture_area_4326_clipTB.geojson",
        label: "Aqua Farm",
        style: {
          color: "#00ff88",
          weight: 2,
          fillColor: "#00ff88",
          fillOpacity: 0.3
        }
      },
      {
        name: "Harbour Military Practice Areas",
        file: "Harbour_Military_Practice_Area_4326_clipTB.geojson",
        label: "Military",
        style: {
          color: "#ff0000",
          weight: 2,
          fillColor: "#ff0000",
          fillOpacity: 0.2
        }
      },

      // ---- Harbour (second batch) ----
      {
        name: "Harbour Navigation Lines",
        file: "Harbour_Navigation_Line_4326_clipTB.geojson",
        label: "Navigation Line",
        style: {
          color: "#00ffff",
          weight: 2
        }
      },
      {
        name: "Harbour Obstructions",
        file: "Harbour_Obstruction_area_4326_clipTB.geojson",
        label: "Obstruction",
        style: {
          color: "#ff3300",
          weight: 2,
          fillColor: "#ff3300",
          fillOpacity: 0.3
        }
      },
      {
        name: "Harbour Offshore Platforms",
        file: "Harbour_Offshore_Platform_point_4326_clipTB.geojson",
        label: "Offshore Platform",
        pointClass: "offshore-platform"
      },
      {
        name: "Harbour Radar Transponder Beacons",
        file: "Harbour_Radar_Transponder_Beacon_point_4326_clipTB.geojson",
        label: "Beacon",
        pointClass: "beacon"
      },
      {
        name: "Harbour Wrecks",
        file: "Harbour_Wreck_point_4326_clipTB.geojson",
        label: "Wreck",
        pointClass: "wreck"
      },

      // ---- Overview ----
      {
        name: "Overview Wrecks",
        file: "Overview_Wreck_point_4326_clipTB.geojson",
        label: "Wreck",
        pointClass: "wreck"
      }
    ];

    // Load ENC layers and attach kid-friendly popups

    encLayers.forEach(function (cfg) {
      fetch(cfg.file)
        .then(function (response) {
          console.log("Fetching " + cfg.name + ": " + cfg.file + " status " + response.status);
          if (!response.ok) {
            throw new Error("HTTP " + response.status);
          }
          return response.json();
        })
        .then(function (data) {
          console.log(
            cfg.name + " features:",
            (data && data.features && data.features.length)
              ? data.features.length
              : "no features array"
          );

          var layer = L.geoJSON(data, {
            style: cfg.style,
            pointToLayer: function (feature, latlng) {
              if (cfg.pointClass) {
                return makePointMarker(cfg.pointClass, latlng);
              }
              return makePointMarker("default", latlng);
            },
            onEachFeature: function (feature, lyr) {
              var text = cfg.label || cfg.name;
              var html = '<div class="nole-popup-label">' + text + '</div>';
              lyr.bindPopup(html);
            }
          });

          layer.addTo(map);
          layer.bringToFront();
        })
        .catch(function (err) {
          console.error("Error loading " + cfg.name + ":", err);
        });
    });

    // Global Fishing Watch via Cloudflare Worker proxy (fishing events)

    const GFW_PROXY_URL = "https://nole-gfw-proxy.asw5230.workers.dev";

    const gfwLayer = L.layerGroup().addTo(map);

    function buildGfwUrl() {
      const minLon = -83.2;
      const minLat = 26.9;
      const maxLon = -81.9;
      const maxLat = 28.6;

      const params = [
        "bbox=" + [minLon, minLat, maxLon, maxLat].join(","),
        "limit=200"
      ];

      return GFW_PROXY_URL + "?" + params.join("&");
    }

    function fetchGfwVessels() {
      const url = buildGfwUrl();
      console.log("Fetching fishing events via proxy:", url);

      fetch(url)
        .then(function (response) {
          console.log("Proxy response status:", response.status);
          if (!response.ok) {
            throw new Error("Proxy HTTP " + response.status);
          }
          return response.json();
        })
        .then(function (data) {
          console.log("Raw GFW proxy JSON:", data);

          if (!data || !Array.isArray(data.entries)) {
            console.warn("GFW proxy: no entries array in response");
            return;
          }

          gfwLayer.clearLayers();

          data.entries.forEach(function (e) {
            // Match the JSON you pasted: position.lat / position.lon / vessel.name / fishing.averageSpeedKnots
            if (!e.position || e.position.lat == null || e.position.lon == null) return;

            const lat = e.position.lat;
            const lon = e.position.lon;

            const name = (e.vessel && e.vessel.name) ? e.vessel.name : "Fishing Vessel";
            const speed = e.fishing && e.fishing.averageSpeedKnots != null
              ? e.fishing.averageSpeedKnots
              : null;
            const eventType = e.type || "fishing";

            let popupHtml = '<div class="nole-popup-label">' + name + '</div>';
            popupHtml += '<div>Event: ' + eventType + '</div>';
            if (speed !== null) {
              popupHtml += '<div>Average Speed: ' + speed.toFixed(1) + ' kn</div>';
            }

            const marker = L.circleMarker([lat, lon], {
              radius: 6,
              color: "#00e0ff",
              weight: 2,
              fillColor: "#00e0ff",
              fillOpacity: 0.9
            });

            marker.bindPopup(popupHtml).addTo(gfwLayer);
          });

          console.log("Fishing events drawn:", data.entries.length);
        })
        .catch(function (err) {
          console.error("Error fetching fishing events via proxy:", err);
        });
    }

    // Initial fetch + refresh every 60 seconds
    fetchGfwVessels();
    setInterval(fetchGfwVessels, 60000);

    // Add a toggle in the layer control for the AIS/fishing-events layer
    L.control.layers(
      null,
      { "Fishing Events (GFW)": gfwLayer },
      { collapsed: true }
    ).addTo(map);

   
    // Re-assert bounds
   
    map.setMaxBounds(tampaBounds);
  </script>
</body>
</html>
