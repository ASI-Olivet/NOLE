<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NOLE — Tampa Bay Map</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .nole-popup-label {
      font-size: 14px;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script>

    // Base Map + Panes

    const tampaBounds = L.latLngBounds(
      [26.9, -83.2],  // SW
      [28.6, -81.9]   // NE
    );

    const map = L.map("map", {
      minZoom: 9,
      maxZoom: 18,
      maxBounds: tampaBounds,
      maxBoundsViscosity: 0.9
    }).setView([27.77, -82.64], 11);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "© OpenStreetMap, Vessel data from Global Fishing Watch."
    }).addTo(map);

    // **** New pane ensures vessels appear on TOP ****
    map.createPane("top-vessels");
    map.getPane("top-vessels").style.zIndex = 10000;

    // Ship Marker  (vessels = large triangle, outline 680093, fill D5FC79)

    function makePortVisitMarker(lat, lon) {
      const icon = L.divIcon({
        className: "",
        iconSize: [26, 26],
        iconAnchor: [13, 13],
        html:
          '<div style="position:relative;width:0;height:0;">' +
            '<div style="' +
              'position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);' +
              'width:0;height:0;' +
              'border-left:10px solid transparent;' +
              'border-right:10px solid transparent;' +
              'border-bottom:18px solid #D5FC79;' +   /* fill color */ 
              'box-shadow:0 0 0 3px #680093;' +       /* outline color */ 
            '"></div>' +
          '</div>'
      });

      return L.marker([lat, lon], {
        icon: icon,
        pane: "top-vessels"
      });
    }

    // Load ENC GeoJSON (unchanged)

    const encLayers = [
      { name: "Coastal Wrecks", file: "Coastal_Wreck_point_4326_clipTB.geojson", label: "Wreck", pointClass: "wreck" },
      { name: "Harbour Buoy", file: "Harbour_Buoy_Special_Purpose_General_point_4326_clipTB.geojson", label: "Buoy", pointClass: "buoy" },
      { name: "Harbour Coastline", file: "Harbour_Coastline_line_4326_clipTB.geojson", label: "Coastline", style: { color: "#ffffff", weight: 1 } },
      // (You can add the rest again later — trimmed for clarity)
    ];

    // ENC point symbology:
    // Buoys        -> blue circle
    // Wrecks       -> red X
    // Military/CG  -> medium square FFC000
    // Fog signal   -> medium square FFFF2C
    // Offshore plat-> medium square D86DCD
    // Default      -> gray circle ADADAD

    function makePointMarker(pointClass, latlng) {
      // Buoys: keep blue circle markers
      if (pointClass === "buoy") {
        return L.circleMarker(latlng, {
          radius: 5,
          color: "#0432FF",
          weight: 1,
          fillColor: "#0432FF",
          fillOpacity: 0.9
        });
      }

      // Wrecks: red X (FF0000)
      if (pointClass === "wreck") {
        return L.marker(latlng, {
          icon: L.divIcon({
            className: "",
            iconSize: [16, 16],
            iconAnchor: [8, 8],
            html:
              '<div style="color:#FF0000;font-size:18px;font-weight:bold;line-height:16px;">×</div>'
          })
        });
      }

      // Military and coast guard: medium square FFC000
      if (pointClass === "coastguard" || pointClass === "military") {
        return L.marker(latlng, {
          icon: L.divIcon({
            className: "",
            iconSize: [14, 14],
            iconAnchor: [7, 7],
            html:
              '<div style="width:14px;height:14px;background:#FFC000;"></div>'
          })
        });
      }

      // Fog signal: medium square FFFF2C
      if (pointClass === "fog-signal") {
        return L.marker(latlng, {
          icon: L.divIcon({
            className: "",
            iconSize: [14, 14],
            iconAnchor: [7, 7],
            html:
              '<div style="width:14px;height:14px;background:#FFFF2C;"></div>'
          })
        });
      }

      // Offshore platform: medium square D86DCD
      if (pointClass === "offshore-platform") {
        return L.marker(latlng, {
          icon: L.divIcon({
            className: "",
            iconSize: [14, 14],
            iconAnchor: [7, 7],
            html:
              '<div style="width:14px;height:14px;background:#D86DCD;"></div>'
          })
        });
      }

      // Default "other": gray circle ADADAD
      return L.circleMarker(latlng, {
        radius: 5,
        color: "#ADADAD",
        weight: 1,
        fillColor: "#ADADAD",
        fillOpacity: 0.9
      });
    }

    encLayers.forEach(cfg => {
      fetch(cfg.file)
        .then(r => r.json())
        .then(data => {
          L.geoJSON(data, {
            style: cfg.style,
            pointToLayer: (feature, latlng) =>
              cfg.pointClass ? makePointMarker(cfg.pointClass, latlng)
                             : makePointMarker("default", latlng),
            onEachFeature: (feature, layer) => {
              layer.bindPopup(
                `<div class="nole-popup-label">${cfg.label}</div>`
              );
            }
          }).addTo(map);
        })
        .catch(err => console.error("ENC load error:", cfg.name, err));
    });

    // Live GFW Port-Visit Vessels

    const PROXY = "https://nole-gfw-proxy.asw5230.workers.dev";
    const vesselsLayer = L.layerGroup().addTo(map);

    function buildUrl() {
      const minLat = 26.9;
      const maxLat = 28.6;
      const minLon = -83.2;
      const maxLon = -81.9;

      const bbox = [minLon, minLat, maxLon, maxLat].join(",");

      console.log("Port visits bbox string:", bbox);

      return `${PROXY}?bbox=${encodeURIComponent(bbox)}&limit=100`;
    }

    function fetchVessels() {
      const url = buildUrl();
      console.log("Fetching port visits via proxy:", url);

      fetch(url)
        .then(r => {
          console.log("Port visits proxy response status:", r.status);
          return r.json();
        })
        .then(data => {
          console.log("Raw port visits JSON:", data);

          vesselsLayer.clearLayers();

          if (!Array.isArray(data.entries)) {
            console.warn("No entries[] found in GFW response.");
            return;
          }

          let count = 0;

          data.entries.forEach(e => {
            if (!e.position || e.position.lat == null || e.position.lon == null)
              return;

            const lat = e.position.lat;
            const lon = e.position.lon;

            const marker = makePortVisitMarker(lat, lon);

            const name = e.vessel?.name || "Vessel";
            const type = e.type || "port_visit";

            marker.bindPopup(`
              <div class="nole-popup-label">${name}</div>
              <div>Event: ${type}</div>
            `);

            marker.addTo(vesselsLayer);
            count++;
          });

          console.log("Port visit markers drawn:", count);
        })
        .catch(err => console.error("Port visit fetch error:", err));
    }

    // Initial load + refresh every 60 seconds
    fetchVessels();
    setInterval(fetchVessels, 60000);

    L.control.layers(null, { "Live Port Visits": vesselsLayer }, { collapsed: true }).addTo(map);
  </script>
</body>
</html>
